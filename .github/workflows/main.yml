name: CICD

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ğŸ“¥ Checkout code
      - name: Checkout code
        uses: actions/checkout@v2

      # ğŸ“¦ Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      # ğŸ” Retrieve contribution data (PR info for latest commit)
      - name: Retrieve contribution data
        id: get_contribution_data
        run: |
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/AaronEdwardGlenn/olio-hackathon-q2-2025/commits/${{ github.sha }}/pulls" \
            > contribution_data.json
          echo "data=$(cat contribution_data.json | jq -c '.')" >> $GITHUB_OUTPUT

      # ğŸ” Retrieve all commits
      - name: Retrieve all commits
        id: get_all_commits
        run: |
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/AaronEdwardGlenn/olio-hackathon-q2-2025/commits" \
            > all_commits.json
          echo "data=$(cat all_commits.json | jq -c '.')" >> $GITHUB_OUTPUT

      # ğŸ› ï¸ Set environment variables
      - name: Set environment variables
        run: |
          username=$(echo '${{ steps.get_contribution_data.outputs.data }}' | jq -r '.[0].user.login')
          avatar_url=$(echo '${{ steps.get_contribution_data.outputs.data }}' | jq -r '.[0].user.avatar_url')
          commit_sha="${{ github.sha }}"
          message=$(echo '${{ steps.get_contribution_data.outputs.data }}' | jq -r '.[0].title')
          commit_count=$(echo '${{ steps.get_all_commits.outputs.data }}' | jq '. | length')

          echo "username=$username" >> $GITHUB_ENV
          echo "avatar_url=$avatar_url" >> $GITHUB_ENV
          echo "commit_sha=$commit_sha" >> $GITHUB_ENV
          echo "message=$message" >> $GITHUB_ENV
          echo "commit_count=$commit_count" >> $GITHUB_ENV

      # ğŸ“‹ Print collected environment variables
      - name: Print collected data
        run: |
          echo "Collected data:"
          echo "Username: ${{ env.username }}"
          echo "Avatar URL: ${{ env.avatar_url }}"
          echo "Commit SHA: ${{ env.commit_sha }}"
          echo "Message: ${{ env.message }}"
          echo "Total Commits: ${{ env.commit_count }}"

      # ğŸ“¦ Install dependencies
      - name: Install dependencies
        run: |
          npm install

      # ğŸ”§ Build project
      - name: Build project
        run: |
          npm run build

      # ğŸ›¡ï¸ Generate Contributor.ts file
      - name: Generate Contributor file
        run: |
          cat <<EOF > src/Contributor.ts
export const Contributor = {
  username: '${{ env.username }}',
  avatar_url: '${{ env.avatar_url }}',
  commit: '${{ env.commit_sha }}',
  message: '${{ env.message }}',
  commit_count: ${{ env.commit_count }}
};
EOF
