name: CICD

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      # 📥 Retrieve contribution data (PR info for latest commit)
      - name: Retrieve contribution data
        id: get_contribution_data
        run: |
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/AaronEdwardGlenn/olio-hackathon-q2-2025/commits/${{ github.sha }}/pulls" \
            > contribution_data.json
          echo "data=$(cat contribution_data.json | jq -c '.')" >> $GITHUB_OUTPUT

      # 📥 Retrieve all commits
      - name: Retrieve all commits
        id: get_all_commits
        run: |
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/AaronEdwardGlenn/olio-hackathon-q2-2025/commits" \
            > all_commits.json
          echo "data=$(cat all_commits.json | jq -c '.')" >> $GITHUB_OUTPUT

      # 🛠️ Store contribution data into environment variables
      - name: Set environment variables
        run: |
          username=$(echo '${{ steps.get_contribution_data.outputs.data }}' | jq -r '.[0].user.login')
          avatar_url=$(echo '${{ steps.get_contribution_data.outputs.data }}' | jq -r '.[0].user.avatar_url')
          commit_count=$(echo '${{ steps.get_all_commits.outputs.data }}' | jq '. | length')

          echo "username=$username" >> $GITHUB_ENV
          echo "avatar_url=$avatar_url" >> $GITHUB_ENV
          echo "commit_count=$commit_count" >> $GITHUB_ENV

      # 📋 Print collected data
      - name: Print collected data
        run: |
          echo "Collected data:"
          echo "Username: ${{ env.username }}"
          echo "Avatar URL: ${{ env.avatar_url }}"
          echo "Total Commits: ${{ env.commit_count }}"

      # 📦 Install dependencies and build
      - name: Install dependencies and build
        run: |
          npm install
          npm run build

      # 🛡️ Generate Contributor file (✅ fixed bad substitution)
      - name: Generate Contributor file
        run: |
          cat <<EOF > src/Contributor.ts
export const Contributor = {
  username: '${{ env.username }}',
  avatar_url: '${{ env.avatar_url }}',
  commit_count: ${{ env.commit_count }}};
EOF
